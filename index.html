<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta
            http-equiv="Cache-Control"
            content="no-cache, no-store, must-revalidate"
        />
        <meta http-equiv="Pragma" content="no-cache" />
        <meta http-equiv="Expires" content="0" />
        <title>Hamina Clipboard Tools</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
        <link
            href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            :root {
                --background: #f0f0f0;
                --foreground: #e0e0e0;
                --text: #333;
                --header: #666;
                --panel-bg: #ffffff;
                --button-bg: #4285f4;
                --button-hover: #3b78e7;
                --button-text: #ffffff;
            }

            body {
                margin: 0;
                padding: 0;
                display: flex;
                font-family: "Quicksand", sans-serif;
                background-color: var(--background);
                color: var(--text);
            }

            #canvas {
                flex-grow: 1;
            }

            /* Left toolbar - tool selection */
            .tool-menu {
                position: fixed;
                top: 20px;
                left: 20px;
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 3;
                padding-left: env(safe-area-inset-left);
                padding-bottom: env(safe-area-inset-bottom);
            }

            .tool-button {
                width: 40px;
                height: 40px;
                border-radius: 6px;
                border: none;
                background-color: var(--panel-bg);
                cursor: pointer;
                font-size: 24px;
                color: var(--text);
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0px 4px 4px 4px rgba(0, 0, 0, 0.025);
                transition: background-color 0.1s;
                -webkit-appearance: none;
                touch-action: manipulation;
                padding: 0;
            }

            .tool-button:hover {
                background-color: var(--foreground);
            }

            .tool-button:active {
                transform: translateY(3px);
                box-shadow: 0px 4px 4px 4px rgba(0, 0, 0, 0.025);
            }

            .tool-button.active {
                background-color: var(--button-bg);
                color: var(--button-text);
            }

            .kbd {
                display: inline-block;
                padding: 3px 5px;
                font:
                    11px/1 "SFMono-Regular",
                    Consolas,
                    "Liberation Mono",
                    Menlo,
                    Courier,
                    monospace;
                color: #444d56;
                vertical-align: middle;
                background-color: #fafbfc;
                border: solid 1px #d1d5da;
                border-bottom-color: #c6cbd1;
                border-radius: 3px;
                box-shadow: inset 0 -1px 0 #c6cbd1;
            }

            .controls-list {
                margin: 0;
                padding-left: 20px;
                font-size: 14px;
            }

            .controls-list li {
                margin-bottom: 8px;
            }

            /* Right panel - tool options */
            .toolbar {
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px;
                background-color: var(--panel-bg);
                border-radius: 6px;
                border: none;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                display: none;
                flex-direction: column;
                gap: 15px;
                z-index: 3;
                width: 280px;
                max-height: calc(100vh - 60px);
                overflow-y: auto;
                box-sizing: border-box;
            }

            .toolbar.visible {
                display: flex;
            }

            .toolbar-description {
                margin: 0;
                font-size: 14px;
                color: var(--text);
            }

            .type-options {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .type-option {
                display: flex;
                align-items: center;
                gap: 8px;
                padding: 8px;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.1s;
            }

            .type-option:hover {
                background-color: var(--foreground);
            }

            .type-option input[type="radio"],
            .type-option input[type="checkbox"] {
                width: auto;
                margin: 0;
            }

            h3 {
                margin: 0;
                font-size: 14px;
                color: var(--header);
                font-weight: 700;
            }

            select,
            input,
            textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid var(--foreground);
                border-radius: 6px;
                font-size: 14px;
                font-family: inherit;
                background-color: var(--background);
                color: var(--text);
                box-sizing: border-box;
            }

            textarea {
                height: 200px;
                font-size: 10px;
                resize: vertical;
            }

            .input-group {
                display: flex;
                gap: 10px;
            }

            .input-group > * {
                flex: 1;
            }

            .rotation-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }

            .toolbar-button {
                width: 100%;
                padding: 8px;
                border-radius: 6px;
                border: none;
                background-color: var(--panel-bg);
                cursor: pointer;
                font-size: 14px;
                font-family: inherit;
                color: var(--text);
                transition: background-color 0.1s;
                -webkit-appearance: none;
                touch-action: manipulation;
                box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.1);
            }

            .toolbar-button:hover {
                background-color: var(--foreground);
            }

            .toolbar-button:active {
                transform: translateY(2px);
            }

            .toolbar-button.blue {
                background-color: var(--button-bg);
                color: var(--button-text);
            }

            .toolbar-button.blue:hover {
                background-color: var(--button-hover);
            }

            .toolbar-button.green {
                background-color: #4caf50;
                color: var(--button-text);
            }

            .toolbar-button.green:hover {
                background-color: #45a049;
            }

            @keyframes pulse-blue {
                0%,
                100% {
                    background-color: var(--button-bg);
                }
                50% {
                    background-color: #6aa3f8;
                }
            }

            .toolbar-button.pending {
                animation: pulse-blue 1.5s ease-in-out infinite;
            }

            .toolbar-button.pending:hover {
                animation: none;
                background-color: var(--button-hover);
            }

            .rotation-button {
                padding: 12px 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 6px;
            }

            /* Toast notifications */
            .toast-container {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                flex-direction: column;
                gap: 10px;
                z-index: 100;
                pointer-events: none;
            }

            .toast {
                background-color: var(--panel-bg);
                color: var(--text);
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.15);
                font-size: 14px;
                opacity: 1;
            }

            .toast.fade-out {
                animation: toast-out 0.3s ease forwards;
            }

            @keyframes toast-out {
                to {
                    opacity: 0;
                }
            }

            .arrow {
                font-size: 16px;
            }

            /* Floating input panel - top center */
            .input-panel {
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 10px;
                background-color: var(--panel-bg);
                border-radius: 6px;
                border: none;
                box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-direction: row;
                gap: 10px;
                z-index: 3;
            }

            .input-panel .toolbar-button {
                padding: 8px 16px;
                white-space: nowrap;
            }
        </style>
    </head>
    <body>
        <div id="canvas"></div>

        <!-- Toast container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Floating input panel - top center -->
        <div class="input-panel">
            <button class="toolbar-button green" onclick="pasteFromClipboard()">
                <i class="bx bx-paste"></i> Paste from Hamina
            </button>
            <button
                class="toolbar-button blue"
                id="copyButton"
                onclick="copyOutput()"
            >
                <i class="bx bx-copy"></i> Copy to Clipboard
            </button>
        </div>

        <!-- Left tool menu -->
        <div class="tool-menu">
            <button
                class="tool-button"
                id="rotateTool"
                onclick="toggleTool('rotate')"
                title="Modify Rotation"
            >
                <i class="bx bx-rotate-left"></i>
            </button>
            <button
                class="tool-button"
                id="changeTypeTool"
                onclick="toggleTool('changeType')"
                title="Modify Object Type"
            >
                <i class="bx bx-transfer"></i>
            </button>
            <button
                class="tool-button"
                id="generateCircleTool"
                onclick="toggleTool('generateCircle')"
                title="Generate Circle"
            >
                <i class="bx bx-circle"></i>
            </button>
            <button
                class="tool-button"
                id="generateGridTool"
                onclick="toggleTool('generateGrid')"
                title="Generate Grid"
            >
                <i class="bx bx-grid-alt"></i>
            </button>
            <button
                class="tool-button"
                id="controlsTool"
                onclick="toggleTool('controls')"
                title="Controls"
            >
                <i class="bx bx-info-circle"></i>
            </button>
        </div>

        <!-- Right panel - Rotate tool options -->
        <div id="rotateToolbar" class="toolbar">
            <h3>Rotate Objects</h3>
            <div class="rotation-grid">
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(-1))"
                >
                    <span class="arrow">↺</span> 1°
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(1))"
                >
                    1° <span class="arrow">↻</span>
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(-5))"
                >
                    <span class="arrow">↺</span> 5°
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(5))"
                >
                    5° <span class="arrow">↻</span>
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(-22.5))"
                >
                    <span class="arrow">↺</span> 22.5°
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(22.5))"
                >
                    22.5° <span class="arrow">↻</span>
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(-45))"
                >
                    <span class="arrow">↺</span> 45°
                </button>
                <button
                    class="toolbar-button rotation-button blue"
                    onclick="rotateObjects(radians(45))"
                >
                    45° <span class="arrow">↻</span>
                </button>
            </div>
        </div>

        <!-- Right panel - Change Type tool options -->
        <div id="changeTypeToolbar" class="toolbar">
            <h3>Convert Zones and Objects</h3>
            <p class="toolbar-description">Convert all zones and objects to:</p>
            <div class="type-options">
                <label class="type-option">
                    <input
                        type="radio"
                        name="targetType"
                        value="attenuatingZone"
                        checked
                    />
                    Attenuating Object
                </label>
                <label class="type-option">
                    <input type="radio" name="targetType" value="holeInclude" />
                    Floor Hole
                </label>
                <label class="type-option">
                    <input type="radio" name="targetType" value="holeExclude" />
                    Building Edge
                </label>
                <label class="type-option">
                    <input
                        type="radio"
                        name="targetType"
                        value="scopeInclude"
                    />
                    Scope Zone
                </label>
                <label class="type-option">
                    <input
                        type="radio"
                        name="targetType"
                        value="capacityZone"
                    />
                    Capacity Zone
                </label>
            </div>
            <button class="toolbar-button blue" onclick="convertObjectType()">
                Convert Zones and Objects
            </button>
        </div>

        <!-- Right panel - Generate Circle tool options -->
        <div id="generateCircleToolbar" class="toolbar">
            <h3>Generate Circle</h3>
            <p class="toolbar-description">Create a circular shape:</p>
            <div class="type-options">
                <label class="type-option">
                    <input
                        type="radio"
                        name="circleType"
                        value="wall"
                        checked
                    />
                    Wall
                </label>
                <label class="type-option">
                    <input
                        type="radio"
                        name="circleType"
                        value="attenuatingZone"
                    />
                    Attenuating Object
                </label>
            </div>
            <div>
                <h3>Segments</h3>
                <input
                    type="number"
                    id="circleSegments"
                    value="18"
                    min="3"
                    max="360"
                    placeholder="Number of segments"
                />
            </div>
            <div>
                <h3>Diameter (Meters)</h3>
                <input
                    type="number"
                    id="circleDiameter"
                    value="6"
                    min="0.1"
                    step="0.1"
                    placeholder="Diameter in meters"
                />
            </div>
            <button class="toolbar-button blue" onclick="generateCircle()">
                Generate Circle
            </button>
        </div>

        <!-- Right panel - Generate Grid tool options -->
        <div id="generateGridToolbar" class="toolbar">
            <h3>Generate Grid</h3>
            <p class="toolbar-description">Create a grid of APs or notes:</p>
            <div class="type-options">
                <label class="type-option">
                    <input
                        type="radio"
                        name="gridType"
                        value="accessPoint"
                        checked
                    />
                    Access Points
                </label>
                <label class="type-option">
                    <input type="radio" name="gridType" value="mapNote" />
                    Map Notes
                </label>
                <label class="type-option">
                    <input type="checkbox" id="gridTriangles" />
                    Triangular Pattern
                </label>
            </div>
            <div>
                <h3>Rows</h3>
                <input
                    type="number"
                    id="gridRows"
                    value="3"
                    min="1"
                    max="100"
                    placeholder="Number of rows"
                />
            </div>
            <div>
                <h3>Columns</h3>
                <input
                    type="number"
                    id="gridColumns"
                    value="3"
                    min="1"
                    max="100"
                    placeholder="Number of columns"
                />
            </div>
            <div>
                <h3>Distance (Meters)</h3>
                <input
                    type="number"
                    id="gridDistance"
                    value="10"
                    min="0.1"
                    step="0.1"
                    placeholder="Distance between points"
                />
            </div>
            <button class="toolbar-button blue" onclick="generateGrid()">
                Generate Grid
            </button>
        </div>

        <!-- Right panel - Controls -->
        <div id="controlsToolbar" class="toolbar">
            <h3>Controls</h3>
            <ul class="controls-list">
                <li>
                    <b>Zoom:</b> Hold <span class="kbd">Shift</span>, drag
                    vertically
                </li>
                <li>
                    <b>Pan:</b> Hold <span class="kbd">Spacebar</span>, move
                    mouse
                </li>
                <li><b>Pan:</b> Use scroll wheel/touchpad</li>
            </ul>
        </div>

        <script>
            let objects;
            let rotation = 0;
            let zoomLevel = 1;
            let centerX = 0;
            let centerY = 0;
            let activeTool = null;
            let jsonData = null; // Store the raw JSON string
            let hasPendingChanges = false;

            // Pan/zoom state
            let panX = 0;
            let panY = 0;
            let isPanning = false;
            let lastMouseX = 0;
            let lastMouseY = 0;
            let spacebarDown = false;
            let spacebarStartMouseX = 0;
            let spacebarStartMouseY = 0;
            let spacebarStartPanX = 0;
            let spacebarStartPanY = 0;

            // AP icon images
            let apIconBase;
            let apIconMask;
            const apIconHotspot = { x: 32, y: 80 };
            const apIconScale = 0.5; // Scale factor for AP icons (adjust as needed)

            // Map note icon images
            let mapNoteIconBase;
            let mapNoteIconMask;
            const mapNoteIconHotspot = { x: 0, y: 64 }; // Bottom left corner of image
            const mapNoteIconScale = 0.5; // Scale factor for map note icons

            function preload() {
                apIconBase = loadImage("images/ap-icon-base.png");
                apIconMask = loadImage("images/ap-icon-mask.png");
                mapNoteIconBase = loadImage("images/map-note-base.png");
                mapNoteIconMask = loadImage("images/map-note-mask.png");
            }

            // ========================================
            // ZONE STYLING CONFIGURATION
            // ========================================
            // Edit these values to adjust the appearance of different zone types.
            // Colors for attenuating objects are derived from their profile color.
            //
            // dashLength: Length of each dash (in canvas units, scaled by zoom)
            // dashGap: Distance between dashes (in canvas units, scaled by zoom)
            // strokeWeight: Width of the dash/stroke line
            // fillOpacity: Opacity of the fill color (0-255, or omit for no fill)
            // strokeDarken: Factor to darken stroke color (0-1, where 0.77 = 77% brightness)

            const zoneStyles = {
                attenuatingZone: {
                    // Color comes from the attenuating zone type profile
                    dashLength: 2,
                    dashGap: 2,
                    strokeWeight: 4,
                    fillOpacity: 128,
                    strokeDarken: 0.77,
                },
                capacityZone: {
                    color: "#4E4F54",
                    dashLength: 2,
                    dashGap: 2,
                    strokeWeight: 2,
                    fillOpacity: 25,
                },
                floorHole: {
                    color: "#85868D",
                    dashLength: 8,
                    dashGap: 8,
                    strokeWeight: 2,
                },
                buildingEdge: {
                    color: "#85868D",
                    dashLength: 8,
                    dashGap: 8,
                    strokeWeight: 2,
                },
                scopeZone: {
                    color: "#85868D",
                    dashLength: 5,
                    dashGap: 5,
                    strokeWeight: 2,
                },
            };
            // ========================================

            function markChangesPending() {
                hasPendingChanges = true;
                const copyButton = document.getElementById("copyButton");
                copyButton.classList.add("pending");
            }

            function clearPendingChanges() {
                hasPendingChanges = false;
                const copyButton = document.getElementById("copyButton");
                copyButton.classList.remove("pending");
            }

            function showToast(message, duration = 2500) {
                const container = document.getElementById("toastContainer");
                const toast = document.createElement("div");
                toast.className = "toast";
                toast.textContent = message;
                container.appendChild(toast);

                setTimeout(() => {
                    toast.classList.add("fade-out");
                    setTimeout(() => {
                        toast.remove();
                    }, 300);
                }, duration);
            }

            async function pasteFromClipboard() {
                try {
                    const text = await navigator.clipboard.readText();
                    jsonData = text;
                    parseInput(text);
                    showToast("Pasted from Hamina");
                } catch (error) {
                    console.error("Failed to read clipboard:", error);
                    alert(
                        "Could not read from clipboard. Please make sure you have copied Hamina objects and allowed clipboard access.",
                    );
                }
            }

            function toggleTool(toolName) {
                const toolButton = document.getElementById(toolName + "Tool");
                const toolbar = document.getElementById(toolName + "Toolbar");

                if (activeTool === toolName) {
                    // Deactivate the tool
                    activeTool = null;
                    toolbar.classList.remove("visible");
                    toolButton.classList.remove("active");
                } else {
                    // Deactivate previous tool if any
                    if (activeTool) {
                        document
                            .getElementById(activeTool + "Tool")
                            .classList.remove("active");
                        document
                            .getElementById(activeTool + "Toolbar")
                            .classList.remove("visible");
                    }
                    // Activate new tool
                    activeTool = toolName;
                    toolbar.classList.add("visible");
                    toolButton.classList.add("active");
                }
            }

            // Default JSON with walls and attenuating zones
            const defaultJSON = `{
              "header": {
                "type": "HaminaClipboard",
                "version": [
                  1,
                  0,
                  0
                ],
                "id": "c84ee30f-5cc3-4cc8-8e0f-d86ad771b77d"
              },
              "walls": [],
              "wallEndpoints": [],
              "wallTypes": [],
              "cableTrays": [],
              "cableTrayEndpoints": [],
              "attenuatingZones": [
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.655673476686257,
                          -7.321092576206411
                        ],
                        [
                          21.682665448643277,
                          -7.320012992901411
                        ],
                        [
                          21.712896457235193,
                          -7.269272577587799
                        ],
                        [
                          21.76580072227089,
                          -6.957273002572492
                        ],
                        [
                          21.785631857001984,
                          -6.64644324521214
                        ],
                        [
                          21.788870893636624,
                          -6.5881457467662585
                        ],
                        [
                          21.850412589698923,
                          -6.452118250393141
                        ],
                        [
                          21.813703507837335,
                          -6.425128667779063
                        ],
                        [
                          21.781313141488777,
                          -6.497460749184029
                        ],
                        [
                          21.735966628600853,
                          -6.550360331106731
                        ],
                        [
                          21.6549907127296,
                          -6.496381165879484
                        ],
                        [
                          21.601006768815708,
                          -6.476948666397675
                        ],
                        [
                          21.579127342215212,
                          -6.376770517153545
                        ],
                        [
                          21.56401183791928,
                          -6.469614681344865
                        ],
                        [
                          21.465761059995565,
                          -6.524673429877112
                        ],
                        [
                          21.412856794959847,
                          -6.570015928668454
                        ],
                        [
                          21.37830707085477,
                          -6.514957180136207
                        ],
                        [
                          21.34051831011505,
                          -6.482569680999859
                        ],
                        [
                          21.315685695914368,
                          -6.433988432294882
                        ],
                        [
                          21.272498540783012,
                          -6.46205759821305
                        ],
                        [
                          21.381546107489626,
                          -6.653143843118869
                        ],
                        [
                          21.40127880263379,
                          -6.972811356617058
                        ],
                        [
                          21.432589490103897,
                          -7.253503015800106
                        ],
                        [
                          21.432589490103897,
                          -7.253503015800106
                        ],
                        [
                          21.460661140939482,
                          -7.304243431114173
                        ],
                        [
                          21.497370222801095,
                          -7.326914680510072
                        ],
                        [
                          21.476468878917306,
                          -6.700793778113166
                        ],
                        [
                          21.50562020863092,
                          -6.54317461564915
                        ],
                        [
                          21.582277408988734,
                          -6.498911700162353
                        ],
                        [
                          21.64813782056403,
                          -6.518344199644162
                        ],
                        [
                          21.679448508034252,
                          -6.562607115130959
                        ],
                        [
                          21.67728915027754,
                          -6.943700021636687
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.750450025009563,
                          -6.21896218906295
                        ],
                        [
                          21.757991587361385,
                          -6.243470097061163
                        ],
                        [
                          21.741023072070377,
                          -6.27080584059695
                        ],
                        [
                          21.70802873678234,
                          -6.264207557674581
                        ],
                        [
                          21.69860178384271,
                          -6.24064226152268
                        ],
                        [
                          21.70802873678228,
                          -6.223675248293603
                        ],
                        [
                          21.72499725207327,
                          -6.218962189063404
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.531744716815005,
                          -6.314165985516411
                        ],
                        [
                          21.551541317987656,
                          -6.332075610591346
                        ],
                        [
                          21.55154131798773,
                          -6.358468742281275
                        ],
                        [
                          21.529859326227147,
                          -6.357526130435417
                        ],
                        [
                          21.501578467408752,
                          -6.32830516320746
                        ],
                        [
                          21.511005420348216,
                          -6.31039553813207
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.38562694625379,
                          -6.219904800909262
                        ],
                        [
                          21.403538156838543,
                          -6.234986590446169
                        ],
                        [
                          21.39882468036901,
                          -6.252896215522014
                        ],
                        [
                          21.374314602726482,
                          -6.264207557674581
                        ],
                        [
                          21.3535753062595,
                          -6.2500683799835315
                        ],
                        [
                          21.3535753062595,
                          -6.2500683799835315
                        ],
                        [
                          21.35451800155365,
                          -6.221790024601432
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "3beb0bf5-b5f0-4e36-9481-5090ca3f9b50",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          19.359564820189185,
                          -7.443425306285462
                        ],
                        [
                          19.40143324768089,
                          -7.283578188681986
                        ],
                        [
                          19.519426088794187,
                          -7.108507536068828
                        ],
                        [
                          19.673578026378042,
                          -7.0076516166291185
                        ],
                        [
                          19.932401032691384,
                          -6.925825115951284
                        ],
                        [
                          20.077037418572193,
                          -6.901086871559983
                        ],
                        [
                          20.276864004328818,
                          -6.901086871560437
                        ],
                        [
                          20.440531493615122,
                          -6.8687368596642955
                        ],
                        [
                          20.632745638009613,
                          -6.7964250683676255
                        ],
                        [
                          20.718385603333864,
                          -6.771686823976779
                        ],
                        [
                          20.81163801002011,
                          -6.689860323298944
                        ],
                        [
                          20.866828209895626,
                          -6.668927962660291
                        ],
                        [
                          20.91352829370864,
                          -6.599174932149708
                        ],
                        [
                          20.991555817670818,
                          -6.5535043271202085
                        ],
                        [
                          21.012490031416792,
                          -6.505930780214385
                        ],
                        [
                          21.041036686524915,
                          -6.484998419576186
                        ],
                        [
                          21.08671133469772,
                          -6.46977488456605
                        ],
                        [
                          21.143804644913985,
                          -6.357501313868852
                        ],
                        [
                          21.33030945828688,
                          -6.153886533112654
                        ],
                        [
                          21.406433871908344,
                          -6.106312986206831
                        ],
                        [
                          21.501589388935283,
                          -6.0492247299198425
                        ],
                        [
                          21.575810692216205,
                          -6.03590413678603
                        ],
                        [
                          21.634807112772872,
                          -6.045418846167195
                        ],
                        [
                          21.75877945338849,
                          -6.108609174881167
                        ],
                        [
                          21.853934970415562,
                          -6.2265915712073365
                        ],
                        [
                          21.901512728929166,
                          -6.338865141904989
                        ],
                        [
                          21.926253163356087,
                          -6.4016622238204945
                        ],
                        [
                          21.926253163356158,
                          -6.430206351963989
                        ],
                        [
                          21.970024701188475,
                          -6.572926992681005
                        ],
                        [
                          21.97002470118835,
                          -6.610985830205209
                        ],
                        [
                          21.990958914934485,
                          -6.669977028368521
                        ],
                        [
                          21.994765135615392,
                          -6.75370647092268
                        ],
                        [
                          22.01950557004232,
                          -6.793668250323208
                        ],
                        [
                          22.015699349361412,
                          -6.85265944848652
                        ],
                        [
                          22.049955335491035,
                          -6.907844762897184
                        ],
                        [
                          22.052378993373242,
                          -7.199232943316929
                        ],
                        [
                          22.0561852140544,
                          -7.301991804633417
                        ],
                        [
                          22.01051056588155,
                          -7.478965399122444
                        ],
                        [
                          21.95722347634635,
                          -7.56840366730512
                        ],
                        [
                          21.953417255665244,
                          -7.612171330458295
                        ],
                        [
                          21.913451938513965,
                          -7.657841935487795
                        ],
                        [
                          21.913451938513834,
                          -7.695900773012454
                        ],
                        [
                          21.941998593622095,
                          -7.779630215566613
                        ],
                        [
                          22.08916538548276,
                          -7.875917033673886
                        ],
                        [
                          22.21857688863949,
                          -7.910169987445897
                        ],
                        [
                          22.30992618498534,
                          -7.921587638703386
                        ],
                        [
                          22.330860398731176,
                          -7.934908231836744
                        ],
                        [
                          22.311829295326046,
                          -7.946325883094687
                        ],
                        [
                          22.03207207526657,
                          -7.946325883094232
                        ],
                        [
                          21.807505055083173,
                          -7.917781754950738
                        ],
                        [
                          21.695221544991313,
                          -7.879722917426079
                        ],
                        [
                          21.695221544991313,
                          -7.879722917426079
                        ],
                        [
                          21.65335311749962,
                          -7.85117878928304
                        ],
                        [
                          21.54487582808872,
                          -7.900655278064733
                        ],
                        [
                          21.284149711435017,
                          -7.9368111737130675
                        ],
                        [
                          21.188994194407947,
                          -7.9368111737130675
                        ],
                        [
                          21.181536511967735,
                          -7.992226802809
                        ],
                        [
                          21.111121429367742,
                          -8.043606233467017
                        ],
                        [
                          20.871329526459807,
                          -8.087373896620193
                        ],
                        [
                          20.59918474776279,
                          -8.159685687916863
                        ],
                        [
                          20.467870134265702,
                          -8.173006281050675
                        ],
                        [
                          20.56302565129252,
                          -7.988420919056352
                        ],
                        [
                          20.580153644357537,
                          -7.948459139655824
                        ],
                        [
                          20.673406051043905,
                          -7.8761473483587
                        ],
                        [
                          20.753336685346287,
                          -7.841894394586689
                        ],
                        [
                          20.833267319648908,
                          -7.683950218859536
                        ],
                        [
                          20.892263740205752,
                          -7.634473730077843
                        ],
                        [
                          21.00454725029759,
                          -7.623056078820355
                        ],
                        [
                          21.073059222556896,
                          -7.643988439459008
                        ],
                        [
                          21.128249422432496,
                          -7.6991737538696725
                        ],
                        [
                          21.154892967200226,
                          -7.7714855451663425
                        ],
                        [
                          21.154892967200166,
                          -7.695367870117025
                        ],
                        [
                          21.08447788460006,
                          -7.619250195067707
                        ],
                        [
                          20.97029126416771,
                          -7.5964148925531845
                        ],
                        [
                          20.878941967822144,
                          -7.605929601934349
                        ],
                        [
                          20.810429995562714,
                          -7.670629625726178
                        ],
                        [
                          20.740014912962728,
                          -7.817156150195842
                        ],
                        [
                          20.661987389000718,
                          -7.851409103967853
                        ],
                        [
                          20.551606989249397,
                          -7.944653255903177
                        ],
                        [
                          20.412679934389978,
                          -7.942750314026853
                        ],
                        [
                          20.247109334763216,
                          -7.897079708997353
                        ],
                        [
                          20.163372479779525,
                          -7.79432084768132
                        ],
                        [
                          20.00351121117434,
                          -7.664920800097661
                        ],
                        [
                          19.83032817018504,
                          -7.588803125048344
                        ],
                        [
                          19.693773664901673,
                          -7.5621696974531005
                        ],
                        [
                          19.941178009171782,
                          -7.664928558769589
                        ],
                        [
                          20.129585932885167,
                          -7.801940373858088
                        ],
                        [
                          20.22093522923114,
                          -7.9180198283079335
                        ],
                        [
                          20.205710346506635,
                          -7.944661014575104
                        ],
                        [
                          20.148617036290453,
                          -7.944661014575104
                        ],
                        [
                          20.091523726074385,
                          -7.904699235174121
                        ],
                        [
                          20.08962061573404,
                          -7.9541757239562685
                        ],
                        [
                          20.013496202112293,
                          -7.933243363317615
                        ],
                        [
                          19.96972466428006,
                          -7.91611688643161
                        ],
                        [
                          19.9697246642799,
                          -7.975108084594922
                        ],
                        [
                          19.92785623678795,
                          -7.975108084594467
                        ],
                        [
                          20.02872108483649,
                          -8.026487515252938
                        ],
                        [
                          19.971627774620433,
                          -8.058837527148626
                        ],
                        [
                          19.86695670589077,
                          -8.051225759643785
                        ],
                        [
                          19.86695670589077,
                          -8.051225759643785
                        ],
                        [
                          19.62145547196143,
                          -7.929437479565422
                        ],
                        [
                          19.431144437907413,
                          -7.7733962457145935
                        ],
                        [
                          19.364535575988608,
                          -7.596422651225112
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.633555808560633,
                          -6.312280761823786
                        ],
                        [
                          21.649581628557808,
                          -6.316051209208581
                        ],
                        [
                          21.649581628557783,
                          -6.3330182224376586
                        ],
                        [
                          21.61941537915151,
                          -6.361296577819758
                        ],
                        [
                          21.596790692097137,
                          -6.357526130435417
                        ],
                        [
                          21.59396260621503,
                          -6.336788669821544
                        ],
                        [
                          21.610931121506134,
                          -6.318879044746609
                        ]
                      ]
                    ]
                  }
                }
              ],
              "attenuatingZoneTypes": [
                {
                  "id": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "name": "Walrus Features",
                  "color": "#6AABF0",
                  "shortcutKey": "",
                  "topEdge": 1.6,
                  "bottomEdge": null,
                  "attenuationDbPerMeter": 10,
                  "ituRModelEnabled": true,
                  "transparencyEnabled": false
                },
                {
                  "id": "3beb0bf5-b5f0-4e36-9481-5090ca3f9b50",
                  "name": "Walrus Blubber",
                  "color": "#2E6CC7",
                  "shortcutKey": "",
                  "topEdge": 1.4,
                  "bottomEdge": null,
                  "attenuationDbPerMeter": 30,
                  "ituRModelEnabled": true,
                  "transparencyEnabled": false
                }
              ],
              "scopeZones": [],
              "capacityZones": [],
              "holeInFloorZones": [],
              "accessPoints": [],
              "mapNotes": [],
              "tiePoints": [],
              "cableRisers": [],
              "clientDevices": [],
              "networkInfraDevices": [],
              "raisedFloorZones": [],
              "slopedFloors": []
            }`;

            function setup() {
                const canvas = createCanvas(windowWidth, windowHeight);
                canvas.parent("canvas");

                // Load default JSON and render it
                jsonData = defaultJSON;
                parseInput(defaultJSON);
            }

            function draw() {
                background(240);
                translate(width / 2 + panX, height / 2 + panY);
                rotate(rotation);
                scale(zoomLevel);

                // Draw walls first (behind other objects)
                if (
                    objects &&
                    objects.walls &&
                    objects.wallEndpoints &&
                    objects.wallTypes
                ) {
                    drawWalls();
                }

                // Draw attenuating zones
                if (objects && objects.attenuatingZones) {
                    for (let zone of objects.attenuatingZones) {
                        const type = objects.attenuatingZoneTypes?.find(
                            (t) => t.id === zone.typeId,
                        );
                        const zoneColor =
                            type && type.color ? type.color : "#7AC2AF";
                        drawZone(
                            zone.area.coordinates[0],
                            zoneColor,
                            zoneStyles.attenuatingZone,
                        );
                    }
                }

                // Draw scope zones
                if (objects && objects.scopeZones) {
                    for (let zone of objects.scopeZones) {
                        drawZone(
                            zone.area.coordinates[0],
                            zoneStyles.scopeZone.color,
                            zoneStyles.scopeZone,
                        );
                    }
                }

                // Draw hole in floor zones (INCLUDE = floor hole, EXCLUDE = building edge)
                if (objects && objects.holeInFloorZones) {
                    for (let zone of objects.holeInFloorZones) {
                        if (zone.type === "INCLUDE") {
                            // Floor hole - shadow inside
                            drawZone(
                                zone.area.coordinates[0],
                                zoneStyles.floorHole.color,
                                zoneStyles.floorHole,
                            );
                        } else {
                            // Building edge - shadow outside
                            drawZone(
                                zone.area.coordinates[0],
                                zoneStyles.buildingEdge.color,
                                zoneStyles.buildingEdge,
                            );
                        }
                    }
                }

                // Draw capacity zones
                if (objects && objects.capacityZones) {
                    for (let zone of objects.capacityZones) {
                        drawZone(
                            zone.area.coordinates[0],
                            zoneStyles.capacityZone.color,
                            zoneStyles.capacityZone,
                        );
                    }
                }

                // Draw access points
                if (objects && objects.accessPoints) {
                    for (let ap of objects.accessPoints) {
                        const apColor = ap.color || "#4687f0";
                        drawAccessPoint(
                            ap.x - centerX,
                            ap.y - centerY,
                            apColor,
                        );
                    }
                }

                // Draw map notes
                if (objects && objects.mapNotes) {
                    for (let note of objects.mapNotes) {
                        const noteColor = note.color || "#db6921";
                        drawMapNote(
                            note.x - centerX,
                            note.y - centerY,
                            noteColor,
                        );
                    }
                }
            }

            function darkenColor(hexColor, factor) {
                // Convert hex to RGB, multiply by factor, convert back
                let c = color(hexColor);
                let r = Math.round(red(c) * factor);
                let g = Math.round(green(c) * factor);
                let b = Math.round(blue(c) * factor);
                return color(r, g, b);
            }

            function drawZone(coordinates, zoneColor, style) {
                // Transform coordinates to canvas space
                const canvasCoords = coordinates.map((coord) => [
                    coord[0] - centerX,
                    coord[1] - centerY,
                ]);

                // Draw filled shape (only if fillOpacity is defined)
                if (style.fillOpacity !== undefined) {
                    let c = color(zoneColor);
                    c.setAlpha(style.fillOpacity);
                    fill(c);
                    noStroke();
                    beginShape();
                    for (let coord of canvasCoords) {
                        vertex(coord[0], coord[1]);
                    }
                    endShape(CLOSE);
                }

                // Calculate stroke color (darken if specified)
                let strokeColor = zoneColor;
                if (style.strokeDarken) {
                    strokeColor = darkenColor(zoneColor, style.strokeDarken);
                }

                // Draw dashed outline
                drawDashedOutline(canvasCoords, strokeColor, style);
            }

            function drawAccessPoint(x, y, apColor) {
                // Save current transformation state
                push();

                // Move to AP position
                translate(x, y);

                // Counter-rotate to keep icon upright
                rotate(-rotation);

                // Calculate icon size (scale by apIconScale, and compensate for zoom)
                const iconScale = apIconScale / zoomLevel;
                const drawWidth = apIconBase.width * iconScale;
                const drawHeight = apIconBase.height * iconScale;

                // Offset by hotspot so icon is anchored at bottom center
                const drawX = -apIconHotspot.x * iconScale;
                const drawY = -apIconHotspot.y * iconScale;

                // Draw base icon (white with grey outline)
                noTint();
                image(apIconBase, drawX, drawY, drawWidth, drawHeight);

                // Draw color mask with tint
                tint(apColor);
                image(apIconMask, drawX, drawY, drawWidth, drawHeight);
                noTint();

                // Restore transformation state
                pop();
            }

            function drawMapNote(x, y, noteColor) {
                // Save current transformation state
                push();

                // Move to map note position
                translate(x, y);

                // Counter-rotate to keep icon upright
                rotate(-rotation);

                // Calculate icon size (scale by mapNoteIconScale, and compensate for zoom)
                const iconScale = mapNoteIconScale / zoomLevel;
                const drawWidth = mapNoteIconBase.width * iconScale;
                const drawHeight = mapNoteIconBase.height * iconScale;

                // Offset by hotspot so icon is anchored at bottom left
                const drawX = -mapNoteIconHotspot.x * iconScale;
                const drawY = -mapNoteIconHotspot.y * iconScale;

                // Draw base icon (white with grey outline)
                noTint();
                image(mapNoteIconBase, drawX, drawY, drawWidth, drawHeight);

                // Draw color mask with tint
                tint(noteColor);
                image(mapNoteIconMask, drawX, drawY, drawWidth, drawHeight);
                noTint();

                // Restore transformation state
                pop();
            }

            function drawWalls() {
                const wallWidth = 4;
                const borderWidth = 1;
                const totalWidth = wallWidth + borderWidth * 2;
                const borderColor = "#333333";

                // Collect wall data for rendering
                const wallData = [];
                for (let wall of objects.walls) {
                    const wallType = objects.wallTypes.find(
                        (t) => t.id === wall.materialId,
                    );
                    const startEndpoint = objects.wallEndpoints.find(
                        (e) => e.id === wall.startId,
                    );
                    const endEndpoint = objects.wallEndpoints.find(
                        (e) => e.id === wall.endId,
                    );

                    if (wallType && startEndpoint && endEndpoint) {
                        wallData.push({
                            x1: startEndpoint.x - centerX,
                            y1: startEndpoint.y - centerY,
                            x2: endEndpoint.x - centerX,
                            y2: endEndpoint.y - centerY,
                            color: wallType.color || "#000000",
                        });
                    }
                }

                // First pass: draw borders (thick lines in border color)
                stroke(borderColor);
                strokeWeight(totalWidth / zoomLevel);
                strokeCap(SQUARE);
                for (let w of wallData) {
                    line(w.x1, w.y1, w.x2, w.y2);
                }

                // Second pass: draw wall fill (thinner lines in wall color)
                // This covers the border where walls meet at endpoints
                strokeWeight(wallWidth / zoomLevel);
                for (let w of wallData) {
                    stroke(w.color);
                    line(w.x1, w.y1, w.x2, w.y2);
                }
            }

            function drawDashedOutline(canvasCoords, strokeColor, style) {
                stroke(strokeColor);
                strokeWeight(style.strokeWeight / zoomLevel);
                strokeCap(SQUARE); // Flat ends instead of rounded
                noFill();

                for (let i = 0; i < canvasCoords.length; i++) {
                    let start = canvasCoords[i];
                    let end = canvasCoords[(i + 1) % canvasCoords.length];
                    drawDashedLine(start[0], start[1], end[0], end[1], style);
                }
            }

            function drawDashedLine(x1, y1, x2, y2, style) {
                let dashLength = style.dashLength / zoomLevel;
                let gapLength = style.dashGap / zoomLevel;

                let xd = x2 - x1;
                let yd = y2 - y1;
                let dist = sqrt(xd * xd + yd * yd);
                let dashCount = Math.floor(dist / (dashLength + gapLength));
                let dashRemaining = dist - dashCount * (dashLength + gapLength);

                for (let i = 0; i < dashCount; i++) {
                    let startT = (i * (dashLength + gapLength)) / dist;
                    let endT = startT + dashLength / dist;

                    let sx = lerp(x1, x2, startT);
                    let sy = lerp(y1, y2, startT);
                    let ex = lerp(x1, x2, endT);
                    let ey = lerp(y1, y2, endT);

                    line(sx, sy, ex, ey);
                }

                if (dashRemaining > 0) {
                    let startT = 1 - dashRemaining / dist;
                    line(lerp(x1, x2, startT), lerp(y1, y2, startT), x2, y2);
                }
            }

            function windowResized() {
                resizeCanvas(windowWidth, windowHeight);
            }

            // Pan and zoom controls
            let shiftDown = false;
            let isZooming = false;
            let zoomStartY = 0;
            let zoomStartLevel = 1;
            let zoomStartPanX = 0;
            let zoomStartPanY = 0;
            let zoomAnchorScreenX = 0;
            let zoomAnchorScreenY = 0;

            function mousePressed() {
                if (shiftDown) {
                    isZooming = true;
                    zoomStartY = mouseY;
                    zoomStartLevel = zoomLevel;
                    zoomStartPanX = panX;
                    zoomStartPanY = panY;
                    // Store the screen position where zoom started
                    zoomAnchorScreenX = mouseX;
                    zoomAnchorScreenY = mouseY;
                } else if (mouseButton === CENTER) {
                    isPanning = true;
                    lastMouseX = mouseX;
                    lastMouseY = mouseY;
                }
            }

            function mouseReleased() {
                isPanning = false;
                isZooming = false;
            }

            function mouseMoved() {
                // Spacebar + mouse move to pan (no click required)
                if (spacebarDown) {
                    panX = spacebarStartPanX + (mouseX - spacebarStartMouseX);
                    panY = spacebarStartPanY + (mouseY - spacebarStartMouseY);
                }
                lastMouseX = mouseX;
                lastMouseY = mouseY;
            }

            function mouseDragged() {
                if (isZooming) {
                    // Drag up to zoom in, drag down to zoom out
                    const dragDistance = zoomStartY - mouseY;
                    const newZoomLevel =
                        zoomStartLevel * Math.pow(1.01, dragDistance);

                    // Calculate world position of anchor at start of zoom
                    const anchorWorldX =
                        (zoomAnchorScreenX - width / 2 - zoomStartPanX) /
                        zoomStartLevel;
                    const anchorWorldY =
                        (zoomAnchorScreenY - height / 2 - zoomStartPanY) /
                        zoomStartLevel;

                    // Calculate new pan to keep anchor point at same screen position
                    panX =
                        zoomAnchorScreenX -
                        width / 2 -
                        anchorWorldX * newZoomLevel;
                    panY =
                        zoomAnchorScreenY -
                        height / 2 -
                        anchorWorldY * newZoomLevel;

                    zoomLevel = newZoomLevel;
                } else if (isPanning) {
                    panX += mouseX - lastMouseX;
                    panY += mouseY - lastMouseY;
                    lastMouseX = mouseX;
                    lastMouseY = mouseY;
                }
            }

            function mouseWheel(event) {
                // Check if this is a pinch-to-zoom (ctrlKey is set) or regular scroll
                if (event.ctrlKey) {
                    // Pinch-to-zoom on trackpad - zoom centered on mouse pointer
                    const oldZoom = zoomLevel;

                    // Calculate world position under mouse before zoom
                    const worldX = (mouseX - width / 2 - panX) / oldZoom;
                    const worldY = (mouseY - height / 2 - panY) / oldZoom;

                    // Apply zoom
                    const zoomFactor = 1.1;
                    if (event.delta > 0) {
                        zoomLevel /= zoomFactor;
                    } else {
                        zoomLevel *= zoomFactor;
                    }

                    // Adjust pan so the same world point stays under the mouse
                    panX = mouseX - width / 2 - worldX * zoomLevel;
                    panY = mouseY - height / 2 - worldY * zoomLevel;
                } else {
                    // Regular scroll - pan the map
                    panX -= event.deltaX;
                    panY -= event.delta;
                }

                // Prevent default scroll behavior
                return false;
            }

            function keyPressed() {
                if (key === " ") {
                    spacebarDown = true;
                    spacebarStartMouseX = mouseX;
                    spacebarStartMouseY = mouseY;
                    spacebarStartPanX = panX;
                    spacebarStartPanY = panY;
                    document.body.style.cursor = "grabbing";
                }
                if (keyCode === SHIFT) {
                    shiftDown = true;
                }
            }

            function keyReleased() {
                if (key === " ") {
                    spacebarDown = false;
                    document.body.style.cursor = "default";
                }
                if (keyCode === SHIFT) {
                    shiftDown = false;
                    isZooming = false;
                }
            }

            // Touch controls for panning
            function touchStarted() {
                if (touches.length === 1) {
                    isPanning = true;
                    lastMouseX = touches[0].x;
                    lastMouseY = touches[0].y;
                }
                // Prevent default to avoid scrolling the page
                return false;
            }

            function touchMoved() {
                if (isPanning && touches.length === 1) {
                    panX += touches[0].x - lastMouseX;
                    panY += touches[0].y - lastMouseY;
                    lastMouseX = touches[0].x;
                    lastMouseY = touches[0].y;
                }
                return false;
            }

            function touchEnded() {
                isPanning = false;
                return false;
            }

            function rotateObjects(angle) {
                rotation += angle;
                markChangesPending();
            }

            function parseInput(input) {
                try {
                    objects = JSON.parse(input);

                    // Flip Y-coordinates for Hamina import
                    const canvasElem = document.getElementById("canvas");
                    const canvasHeight =
                        canvasElem && canvasElem.height
                            ? canvasElem.height
                            : canvas.height;

                    // Helper to flip Y for zone coordinates
                    function flipZoneY(zone) {
                        for (let coord of zone.area.coordinates[0]) {
                            coord[1] = canvasHeight - coord[1];
                        }
                    }

                    // Flip all zone types
                    if (objects.attenuatingZones) {
                        for (let zone of objects.attenuatingZones) {
                            flipZoneY(zone);
                        }
                    }
                    if (objects.scopeZones) {
                        for (let zone of objects.scopeZones) {
                            flipZoneY(zone);
                        }
                    }
                    if (objects.holeInFloorZones) {
                        for (let zone of objects.holeInFloorZones) {
                            flipZoneY(zone);
                        }
                    }
                    if (objects.capacityZones) {
                        for (let zone of objects.capacityZones) {
                            flipZoneY(zone);
                        }
                    }
                    if (objects.wallEndpoints) {
                        for (let endpoint of objects.wallEndpoints) {
                            endpoint.y = canvasHeight - endpoint.y;
                        }
                    }

                    // Flip Y for access points
                    if (objects.accessPoints) {
                        for (let ap of objects.accessPoints) {
                            ap.y = canvasHeight - ap.y;
                        }
                    }

                    // Flip Y for map notes
                    if (objects.mapNotes) {
                        for (let note of objects.mapNotes) {
                            note.y = canvasHeight - note.y;
                        }
                    }

                    calculateCenter();
                    rotation = 0;
                    panX = 0;
                    panY = 0;
                } catch (error) {
                    console.error("Error parsing input:", error);
                    alert("There's something wrong with the input JSON. 😭");
                }
            }

            function calculateCenter() {
                let minX = Infinity,
                    minY = Infinity,
                    maxX = -Infinity,
                    maxY = -Infinity;

                // Helper to update bounds from zone coordinates
                function updateBoundsFromZone(zone) {
                    for (let coord of zone.area.coordinates[0]) {
                        minX = Math.min(minX, coord[0]);
                        minY = Math.min(minY, coord[1]);
                        maxX = Math.max(maxX, coord[0]);
                        maxY = Math.max(maxY, coord[1]);
                    }
                }

                // Calculate bounds from all zone types
                if (objects.attenuatingZones) {
                    for (let zone of objects.attenuatingZones) {
                        updateBoundsFromZone(zone);
                    }
                }
                if (objects.scopeZones) {
                    for (let zone of objects.scopeZones) {
                        updateBoundsFromZone(zone);
                    }
                }
                if (objects.holeInFloorZones) {
                    for (let zone of objects.holeInFloorZones) {
                        updateBoundsFromZone(zone);
                    }
                }
                if (objects.capacityZones) {
                    for (let zone of objects.capacityZones) {
                        updateBoundsFromZone(zone);
                    }
                }

                // Calculate bounds from wall endpoints
                if (objects.wallEndpoints) {
                    for (let endpoint of objects.wallEndpoints) {
                        minX = Math.min(minX, endpoint.x);
                        minY = Math.min(minY, endpoint.y);
                        maxX = Math.max(maxX, endpoint.x);
                        maxY = Math.max(maxY, endpoint.y);
                    }
                }

                // Calculate bounds from access points
                if (objects.accessPoints) {
                    for (let ap of objects.accessPoints) {
                        minX = Math.min(minX, ap.x);
                        minY = Math.min(minY, ap.y);
                        maxX = Math.max(maxX, ap.x);
                        maxY = Math.max(maxY, ap.y);
                    }
                }

                // Calculate bounds from map notes
                if (objects.mapNotes) {
                    for (let note of objects.mapNotes) {
                        minX = Math.min(minX, note.x);
                        minY = Math.min(minY, note.y);
                        maxX = Math.max(maxX, note.x);
                        maxY = Math.max(maxY, note.y);
                    }
                }

                // If no objects found, use defaults
                if (minX === Infinity) {
                    minX = maxX = centerX = 0;
                    minY = maxY = centerY = 0;
                    zoomLevel = 1;
                    return;
                }

                centerX = (minX + maxX) / 2;
                centerY = (minY + maxY) / 2;
                const objectWidth = maxX - minX;
                const objectHeight = maxY - minY;
                zoomLevel =
                    Math.min(width / objectWidth, height / objectHeight) * 0.7;
            }

            function copyOutput() {
                const rotatedObjects = getRotatedObjects();
                if (rotatedObjects) {
                    const output = JSON.stringify(rotatedObjects, null, 2);
                    navigator.clipboard.writeText(output).then(() => {
                        clearPendingChanges();
                        showToast("Copied to clipboard");
                    });
                } else {
                    alert("No objects to copy. Paste objects first.");
                }
            }

            function getRotatedObjects() {
                if (!objects) return null;

                const rotatedObjects = JSON.parse(JSON.stringify(objects));
                const canvasElem = document.getElementById("canvas");
                const canvasHeight =
                    canvasElem && canvasElem.height
                        ? canvasElem.height
                        : canvas.height;

                // Helper to rotate and flip zone coordinates
                function rotateAndFlipZone(zone) {
                    for (let coord of zone.area.coordinates[0]) {
                        const x = coord[0] - centerX;
                        const y = coord[1] - centerY;
                        const rotatedX = x * cos(rotation) - y * sin(rotation);
                        const rotatedY = x * sin(rotation) + y * cos(rotation);
                        coord[0] = rotatedX + centerX;
                        coord[1] = rotatedY + centerY;

                        // Flip Y for Hamina export
                        coord[1] = canvasHeight - coord[1];
                    }
                }

                // Rotate all zone types
                if (rotatedObjects.attenuatingZones) {
                    for (let zone of rotatedObjects.attenuatingZones) {
                        rotateAndFlipZone(zone);
                    }
                }
                if (rotatedObjects.scopeZones) {
                    for (let zone of rotatedObjects.scopeZones) {
                        rotateAndFlipZone(zone);
                    }
                }
                if (rotatedObjects.holeInFloorZones) {
                    for (let zone of rotatedObjects.holeInFloorZones) {
                        rotateAndFlipZone(zone);
                    }
                }
                if (rotatedObjects.capacityZones) {
                    for (let zone of rotatedObjects.capacityZones) {
                        rotateAndFlipZone(zone);
                    }
                }

                // Rotate wall endpoints
                if (rotatedObjects.wallEndpoints) {
                    for (let endpoint of rotatedObjects.wallEndpoints) {
                        const x = endpoint.x - centerX;
                        const y = endpoint.y - centerY;
                        const rotatedX = x * cos(rotation) - y * sin(rotation);
                        const rotatedY = x * sin(rotation) + y * cos(rotation);
                        endpoint.x = rotatedX + centerX;
                        endpoint.y = rotatedY + centerY;

                        // Flip Y for Hamina export
                        endpoint.y = canvasHeight - endpoint.y;
                    }
                }

                // Rotate access points
                if (rotatedObjects.accessPoints) {
                    for (let ap of rotatedObjects.accessPoints) {
                        const x = ap.x - centerX;
                        const y = ap.y - centerY;
                        const rotatedX = x * cos(rotation) - y * sin(rotation);
                        const rotatedY = x * sin(rotation) + y * cos(rotation);
                        ap.x = rotatedX + centerX;
                        ap.y = rotatedY + centerY;

                        // Flip Y for Hamina export
                        ap.y = canvasHeight - ap.y;
                    }
                }

                // Rotate map notes
                if (rotatedObjects.mapNotes) {
                    for (let note of rotatedObjects.mapNotes) {
                        const x = note.x - centerX;
                        const y = note.y - centerY;
                        const rotatedX = x * cos(rotation) - y * sin(rotation);
                        const rotatedY = x * sin(rotation) + y * cos(rotation);
                        note.x = rotatedX + centerX;
                        note.y = rotatedY + centerY;

                        // Flip Y for Hamina export
                        note.y = canvasHeight - note.y;
                    }
                }

                return rotatedObjects;
            }

            function clearObjects() {
                objects = null;
                jsonData = null;
                rotation = 0;
                zoomLevel = 1;
                centerX = 0;
                centerY = 0;
                // Redraw the canvas
                draw();
            }

            function convertObjectType() {
                if (!objects) {
                    alert(
                        "No objects loaded. Please paste and render objects first.",
                    );
                    return;
                }

                const targetType = document.querySelector(
                    'input[name="targetType"]:checked',
                ).value;

                // Collect all polygon areas from all zone types
                const allAreas = [];

                if (objects.attenuatingZones) {
                    for (let zone of objects.attenuatingZones) {
                        allAreas.push(zone.area);
                    }
                }
                if (objects.scopeZones) {
                    for (let zone of objects.scopeZones) {
                        allAreas.push(zone.area);
                    }
                }
                if (objects.holeInFloorZones) {
                    for (let zone of objects.holeInFloorZones) {
                        allAreas.push(zone.area);
                    }
                }
                if (objects.capacityZones) {
                    for (let zone of objects.capacityZones) {
                        allAreas.push(zone.area);
                    }
                }

                if (allAreas.length === 0) {
                    alert("No zones found to convert.");
                    return;
                }

                // Clear all zone arrays
                objects.attenuatingZones = [];
                objects.scopeZones = [];
                objects.holeInFloorZones = [];
                objects.capacityZones = [];

                // Convert to the target type
                switch (targetType) {
                    case "attenuatingZone":
                        // Create a default attenuating zone type if none exists
                        if (
                            !objects.attenuatingZoneTypes ||
                            objects.attenuatingZoneTypes.length === 0
                        ) {
                            objects.attenuatingZoneTypes = [
                                {
                                    id: crypto.randomUUID(),
                                    name: "Converted Zone",
                                    color: "#7AC2AF",
                                    shortcutKey: "",
                                    topEdge: 2,
                                    bottomEdge: null,
                                    attenuationDbPerMeter: 5,
                                    ituRModelEnabled: true,
                                    transparencyEnabled: false,
                                },
                            ];
                        }
                        const typeId = objects.attenuatingZoneTypes[0].id;
                        for (let area of allAreas) {
                            objects.attenuatingZones.push({
                                typeId: typeId,
                                area: area,
                            });
                        }
                        break;

                    case "scopeInclude":
                        for (let area of allAreas) {
                            objects.scopeZones.push({
                                type: "INCLUDE",
                                area: area,
                            });
                        }
                        break;

                    case "scopeExclude":
                        for (let area of allAreas) {
                            objects.scopeZones.push({
                                type: "EXCLUDE",
                                area: area,
                            });
                        }
                        break;

                    case "holeInclude":
                        for (let area of allAreas) {
                            objects.holeInFloorZones.push({
                                type: "INCLUDE",
                                area: area,
                            });
                        }
                        break;

                    case "holeExclude":
                        for (let area of allAreas) {
                            objects.holeInFloorZones.push({
                                type: "EXCLUDE",
                                area: area,
                            });
                        }
                        break;

                    case "capacityZone":
                        for (let area of allAreas) {
                            objects.capacityZones.push({
                                name: "Capacity Zone",
                                deviceAmounts: [
                                    { wifiDevice: "IPHONE", amount: 50 },
                                    { wifiDevice: "MACBOOK", amount: 50 },
                                ],
                                area: area,
                            });
                        }
                        break;
                }

                markChangesPending();
                showToast("Objects converted");
            }

            function generateCircle() {
                const circleType = document.querySelector(
                    'input[name="circleType"]:checked',
                ).value;
                const segments =
                    parseInt(document.getElementById("circleSegments").value) ||
                    32;
                const diameter =
                    parseFloat(
                        document.getElementById("circleDiameter").value,
                    ) || 10;
                const radius = diameter / 2;

                // Generate circle points centered at origin
                const points = [];
                for (let i = 0; i < segments; i++) {
                    const angle = (i / segments) * Math.PI * 2;
                    const x = radius * Math.cos(angle);
                    const y = radius * Math.sin(angle);
                    points.push([x, y]);
                }

                if (circleType === "wall") {
                    // Generate wall-based circle
                    const wallTypeId = crypto.randomUUID();
                    const wallEndpoints = [];
                    const walls = [];

                    // Create endpoints for each point
                    for (let i = 0; i < points.length; i++) {
                        const endpointId = crypto.randomUUID();
                        wallEndpoints.push({
                            id: endpointId,
                            x: points[i][0],
                            y: points[i][1],
                        });
                    }

                    // Create walls connecting consecutive endpoints
                    for (let i = 0; i < wallEndpoints.length; i++) {
                        const nextIndex = (i + 1) % wallEndpoints.length;
                        walls.push({
                            materialId: wallTypeId,
                            startId: wallEndpoints[i].id,
                            endId: wallEndpoints[nextIndex].id,
                        });
                    }

                    // Create the full JSON structure for walls
                    const newObjects = {
                        header: {
                            type: "HaminaClipboard",
                            version: [1, 0, 0],
                            id: crypto.randomUUID(),
                        },
                        walls: walls,
                        wallEndpoints: wallEndpoints,
                        wallTypes: [
                            {
                                id: wallTypeId,
                                name: "Drywall",
                                color: "#937E75",
                                shortcutKey: "",
                                topEdge: null,
                                bottomEdge: null,
                                width: 0.1,
                                reflectivity: 5,
                                attenuation: 3,
                                materialClass: "ITU_R_PLASTERBOARD",
                                deleted: false,
                                defaultTypeId: null,
                                transparencyEnabled: false,
                                autoFillEnabled: false,
                            },
                        ],
                        cableTrays: [],
                        cableTrayEndpoints: [],
                        attenuatingZones: [],
                        attenuatingZoneTypes: [],
                        scopeZones: [],
                        capacityZones: [],
                        holeInFloorZones: [],
                        accessPoints: [],
                        mapNotes: [],
                        tiePoints: [],
                        cableRisers: [],
                        clientDevices: [],
                        networkInfraDevices: [],
                        raisedFloorZones: [],
                        slopedFloors: [],
                    };

                    jsonData = JSON.stringify(newObjects, null, 2);
                    parseInput(jsonData);
                } else {
                    // Generate attenuating zone circle
                    const zoneTypeId = crypto.randomUUID();

                    // Close the polygon by adding the first point at the end
                    const coordinates = points.map((p) => [p[0], p[1]]);

                    const newObjects = {
                        header: {
                            type: "HaminaClipboard",
                            version: [1, 0, 0],
                            id: crypto.randomUUID(),
                        },
                        walls: [],
                        wallEndpoints: [],
                        wallTypes: [],
                        cableTrays: [],
                        cableTrayEndpoints: [],
                        attenuatingZones: [
                            {
                                typeId: zoneTypeId,
                                area: {
                                    type: "Polygon",
                                    coordinates: [coordinates],
                                },
                            },
                        ],
                        attenuatingZoneTypes: [
                            {
                                id: zoneTypeId,
                                name: "Walrus Blubber",
                                color: "#2E6CC7",
                                shortcutKey: "",
                                topEdge: 1.4,
                                bottomEdge: null,
                                attenuationDbPerMeter: 30,
                                ituRModelEnabled: true,
                                transparencyEnabled: false,
                            },
                        ],
                        scopeZones: [],
                        capacityZones: [],
                        holeInFloorZones: [],
                        accessPoints: [],
                        mapNotes: [],
                        tiePoints: [],
                        cableRisers: [],
                        clientDevices: [],
                        networkInfraDevices: [],
                        raisedFloorZones: [],
                        slopedFloors: [],
                    };

                    jsonData = JSON.stringify(newObjects, null, 2);
                    parseInput(jsonData);
                }

                markChangesPending();
                showToast("Circle generated");
            }

            function generateGrid() {
                const gridType = document.querySelector(
                    'input[name="gridType"]:checked',
                ).value;
                const rows =
                    parseInt(document.getElementById("gridRows").value) || 3;
                const columns =
                    parseInt(document.getElementById("gridColumns").value) || 3;
                const distance =
                    parseFloat(document.getElementById("gridDistance").value) ||
                    10;
                const useTriangles =
                    document.getElementById("gridTriangles").checked;

                // Calculate grid dimensions to center it
                const totalWidth = (columns - 1) * distance;
                const totalHeight = (rows - 1) * distance;
                const startX = -totalWidth / 2;
                const startY = -totalHeight / 2;

                if (gridType === "accessPoint") {
                    // Generate access points
                    const accessPoints = [];

                    for (let row = 0; row < rows; row++) {
                        // Offset odd rows by half distance for triangle pattern
                        const rowOffset =
                            useTriangles && row % 2 === 1 ? distance / 2 : 0;
                        for (let col = 0; col < columns; col++) {
                            const x = startX + col * distance + rowOffset;
                            const y = startY + row * distance;
                            const apNumber = row * columns + col + 1;

                            accessPoints.push({
                                x: x,
                                y: y,
                                make: "ciscoCatalystEnt",
                                model: "CW9166",
                                mount: "CEILING",
                                installHeight: 2.5,
                                azimuth: null,
                                elevation: null,
                                externalAntennaMake: null,
                                externalAntennaModel: null,
                                radios: [
                                    {
                                        id: crypto.randomUUID(),
                                        band: "BAND_2_4",
                                        channel: 6,
                                        txPower: 6,
                                        channelWidth: 20,
                                        enabled: false,
                                        channelLocked: false,
                                        port: null,
                                        streamCount: 4,
                                        technology: "WIFI_PROTOCOL_AX",
                                        azimuth: null,
                                        elevation: null,
                                        installHeight: null,
                                        externalAntennaMake: null,
                                        externalAntennaModel: null,
                                        mount: null,
                                    },
                                    {
                                        id: crypto.randomUUID(),
                                        band: "BAND_5",
                                        channel: 36,
                                        txPower: 10,
                                        channelWidth: 20,
                                        enabled: true,
                                        channelLocked: false,
                                        port: null,
                                        streamCount: 4,
                                        technology: "WIFI_PROTOCOL_AX",
                                        azimuth: null,
                                        elevation: null,
                                        installHeight: null,
                                        externalAntennaMake: null,
                                        externalAntennaModel: null,
                                        mount: null,
                                    },
                                    {
                                        id: crypto.randomUUID(),
                                        band: "BAND_6",
                                        channel: 1,
                                        txPower: 12,
                                        channelWidth: 20,
                                        enabled: true,
                                        channelLocked: false,
                                        port: null,
                                        streamCount: 4,
                                        technology: "WIFI_PROTOCOL_AX",
                                        azimuth: null,
                                        elevation: null,
                                        installHeight: null,
                                        externalAntennaMake: null,
                                        externalAntennaModel: null,
                                        mount: null,
                                    },
                                ],
                                primaryTechnology: "WIFI",
                                cellularRadios: [],
                                bleRadios: [
                                    {
                                        id: crypto.randomUUID(),
                                        txPowerDbm: 0,
                                    },
                                ],
                                uwbRadios: [],
                                enoceanRadios: [],
                                enoceanCapable: false,
                                zigbeeRadios: [],
                                color: "#4687f0",
                                name: "Access Point ${number}",
                                number: apNumber,
                                powerConsumption: 30.5,
                                connectedInfraDeviceId: null,
                                ethernetConnection: true,
                                perRadioOriented: false,
                                bank: 0,
                                meshUpstreamAuto: null,
                                meshUpstreamApId: null,
                                meshRadioIndex: null,
                                antennaId: "Cisco C9166",
                            });
                        }
                    }

                    const newObjects = {
                        header: {
                            type: "HaminaClipboard",
                            version: [1, 0, 0],
                            id: crypto.randomUUID(),
                        },
                        walls: [],
                        wallEndpoints: [],
                        wallTypes: [],
                        cableTrays: [],
                        cableTrayEndpoints: [],
                        attenuatingZones: [],
                        attenuatingZoneTypes: [],
                        scopeZones: [],
                        capacityZones: [],
                        holeInFloorZones: [],
                        accessPoints: accessPoints,
                        mapNotes: [],
                        tiePoints: [],
                        cableRisers: [],
                        clientDevices: [],
                        networkInfraDevices: [],
                        raisedFloorZones: [],
                        slopedFloors: [],
                    };

                    jsonData = JSON.stringify(newObjects, null, 2);
                    parseInput(jsonData);
                } else {
                    // Generate map notes
                    const mapNotes = [];

                    for (let row = 0; row < rows; row++) {
                        // Offset odd rows by half distance for triangle pattern
                        const rowOffset =
                            useTriangles && row % 2 === 1 ? distance / 2 : 0;
                        for (let col = 0; col < columns; col++) {
                            const x = startX + col * distance + rowOffset;
                            const y = startY + row * distance;

                            mapNotes.push({
                                x: x,
                                y: y,
                                text: "",
                                color: "#db6921",
                                icon: "NOTICE_OUTLINE",
                            });
                        }
                    }

                    const newObjects = {
                        header: {
                            type: "HaminaClipboard",
                            version: [1, 0, 0],
                            id: crypto.randomUUID(),
                        },
                        walls: [],
                        wallEndpoints: [],
                        wallTypes: [],
                        cableTrays: [],
                        cableTrayEndpoints: [],
                        attenuatingZones: [],
                        attenuatingZoneTypes: [],
                        scopeZones: [],
                        capacityZones: [],
                        holeInFloorZones: [],
                        accessPoints: [],
                        mapNotes: mapNotes,
                        tiePoints: [],
                        cableRisers: [],
                        clientDevices: [],
                        networkInfraDevices: [],
                        raisedFloorZones: [],
                        slopedFloors: [],
                    };

                    jsonData = JSON.stringify(newObjects, null, 2);
                    parseInput(jsonData);
                }

                markChangesPending();
                showToast("Grid generated");
            }
        </script>
    </body>
</html>
