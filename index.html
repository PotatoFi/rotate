<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Hamina Object and Wall Rotation Tool</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
        <style>
            body {
                margin: 0;
                padding: 0;
                display: flex;
                font-family: Arial, sans-serif;
                background-color: #f0f0f0;
            }
            #canvas {
                flex-grow: 1;
            }
            #toolbar {
                padding: 20px;
                background-color: white;
                display: flex;
                flex-direction: column;
                gap: 15px;
            }
            h3 {
                margin: 0;
                font-size: 18px;
                color: #333;
            }
            select,
            input,
            textarea,
            button {
                width: 100%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 14px;
            }
            textarea {
                height: 200px;
                width: 360px;
                font-size: 10px;
                resize: vertical;
            }
            .input-group {
                display: flex;
                gap: 10px;
            }
            .input-group > * {
                flex: 1;
            }
            button {
                background-color: #f0f0f0;
                border: none;
                cursor: pointer;
                transition: background-color 0.3s;
            }
            button:hover {
                background-color: #e0e0e0;
            }
            #copyButton {
                background-color: #4285f4;
                color: white;
            }
            #copyButton:hover {
                background-color: #3b78e7;
            }
            .arrow {
                font-size: 18px;
            }
            #clearButton {
                background-color: #ff4444;
                color: white;
                margin-bottom: 10px;
            }
            #clearButton:hover {
                background-color: #cc0000;
            }
        </style>
    </head>
    <body>
        <div id="canvas"></div>
        <div id="toolbar">
            <h3>Rotation Controls</h3>
            <div class="input-group">
                <button onclick="rotateObjects(radians(-1))">
                    1° <span class="arrow">↺</span>
                </button>
                <button onclick="rotateObjects(radians(-5))">
                    5° <span class="arrow">↺</span>
                </button>
                <button onclick="rotateObjects(radians(-22.5))">
                    22.5° <span class="arrow">↺</span>
                </button>
                <button onclick="rotateObjects(radians(-45))">
                    45° <span class="arrow">↺</span>
                </button>
                <button onclick="rotateObjects(radians(45))">
                    45° <span class="arrow">↻</span>
                </button>
                <button onclick="rotateObjects(radians(22.5))">
                    22.5° <span class="arrow">↻</span>
                </button>
                <button onclick="rotateObjects(radians(5))">
                    5° <span class="arrow">↻</span>
                </button>
                <button onclick="rotateObjects(radians(1))">
                    1° <span class="arrow">↻</span>
                </button>
            </div>
            <h3>Input Objects</h3>

            <textarea
                id="inputArea"
                placeholder="In Hamina Network Planner, select objects, copy to the clipboard, and paste here."
            ></textarea>
            <button onclick="parseInput()">Render Objects</button>
            <button id="clearButton" onclick="clearObjects()">
                Clear Objects
            </button>
            <button id="copyButton" onclick="copyOutput()">
                Copy to clipboard
            </button>
        </div>

        <script>
            let objects;
            let rotation = 0;
            let zoomLevel = 1;
            let centerX = 0;
            let centerY = 0;

            // Default JSON with walls and attenuating zones
            const defaultJSON = `{
              "header": {
                "type": "HaminaClipboard",
                "version": [
                  1,
                  0,
                  0
                ],
                "id": "c84ee30f-5cc3-4cc8-8e0f-d86ad771b77d"
              },
              "walls": [],
              "wallEndpoints": [],
              "wallTypes": [],
              "cableTrays": [],
              "cableTrayEndpoints": [],
              "attenuatingZones": [
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.655673476686257,
                          -7.321092576206411
                        ],
                        [
                          21.682665448643277,
                          -7.320012992901411
                        ],
                        [
                          21.712896457235193,
                          -7.269272577587799
                        ],
                        [
                          21.76580072227089,
                          -6.957273002572492
                        ],
                        [
                          21.785631857001984,
                          -6.64644324521214
                        ],
                        [
                          21.788870893636624,
                          -6.5881457467662585
                        ],
                        [
                          21.850412589698923,
                          -6.452118250393141
                        ],
                        [
                          21.813703507837335,
                          -6.425128667779063
                        ],
                        [
                          21.781313141488777,
                          -6.497460749184029
                        ],
                        [
                          21.735966628600853,
                          -6.550360331106731
                        ],
                        [
                          21.6549907127296,
                          -6.496381165879484
                        ],
                        [
                          21.601006768815708,
                          -6.476948666397675
                        ],
                        [
                          21.579127342215212,
                          -6.376770517153545
                        ],
                        [
                          21.56401183791928,
                          -6.469614681344865
                        ],
                        [
                          21.465761059995565,
                          -6.524673429877112
                        ],
                        [
                          21.412856794959847,
                          -6.570015928668454
                        ],
                        [
                          21.37830707085477,
                          -6.514957180136207
                        ],
                        [
                          21.34051831011505,
                          -6.482569680999859
                        ],
                        [
                          21.315685695914368,
                          -6.433988432294882
                        ],
                        [
                          21.272498540783012,
                          -6.46205759821305
                        ],
                        [
                          21.381546107489626,
                          -6.653143843118869
                        ],
                        [
                          21.40127880263379,
                          -6.972811356617058
                        ],
                        [
                          21.432589490103897,
                          -7.253503015800106
                        ],
                        [
                          21.432589490103897,
                          -7.253503015800106
                        ],
                        [
                          21.460661140939482,
                          -7.304243431114173
                        ],
                        [
                          21.497370222801095,
                          -7.326914680510072
                        ],
                        [
                          21.476468878917306,
                          -6.700793778113166
                        ],
                        [
                          21.50562020863092,
                          -6.54317461564915
                        ],
                        [
                          21.582277408988734,
                          -6.498911700162353
                        ],
                        [
                          21.64813782056403,
                          -6.518344199644162
                        ],
                        [
                          21.679448508034252,
                          -6.562607115130959
                        ],
                        [
                          21.67728915027754,
                          -6.943700021636687
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.750450025009563,
                          -6.21896218906295
                        ],
                        [
                          21.757991587361385,
                          -6.243470097061163
                        ],
                        [
                          21.741023072070377,
                          -6.27080584059695
                        ],
                        [
                          21.70802873678234,
                          -6.264207557674581
                        ],
                        [
                          21.69860178384271,
                          -6.24064226152268
                        ],
                        [
                          21.70802873678228,
                          -6.223675248293603
                        ],
                        [
                          21.72499725207327,
                          -6.218962189063404
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.531744716815005,
                          -6.314165985516411
                        ],
                        [
                          21.551541317987656,
                          -6.332075610591346
                        ],
                        [
                          21.55154131798773,
                          -6.358468742281275
                        ],
                        [
                          21.529859326227147,
                          -6.357526130435417
                        ],
                        [
                          21.501578467408752,
                          -6.32830516320746
                        ],
                        [
                          21.511005420348216,
                          -6.31039553813207
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.38562694625379,
                          -6.219904800909262
                        ],
                        [
                          21.403538156838543,
                          -6.234986590446169
                        ],
                        [
                          21.39882468036901,
                          -6.252896215522014
                        ],
                        [
                          21.374314602726482,
                          -6.264207557674581
                        ],
                        [
                          21.3535753062595,
                          -6.2500683799835315
                        ],
                        [
                          21.3535753062595,
                          -6.2500683799835315
                        ],
                        [
                          21.35451800155365,
                          -6.221790024601432
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "3beb0bf5-b5f0-4e36-9481-5090ca3f9b50",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          19.359564820189185,
                          -7.443425306285462
                        ],
                        [
                          19.40143324768089,
                          -7.283578188681986
                        ],
                        [
                          19.519426088794187,
                          -7.108507536068828
                        ],
                        [
                          19.673578026378042,
                          -7.0076516166291185
                        ],
                        [
                          19.932401032691384,
                          -6.925825115951284
                        ],
                        [
                          20.077037418572193,
                          -6.901086871559983
                        ],
                        [
                          20.276864004328818,
                          -6.901086871560437
                        ],
                        [
                          20.440531493615122,
                          -6.8687368596642955
                        ],
                        [
                          20.632745638009613,
                          -6.7964250683676255
                        ],
                        [
                          20.718385603333864,
                          -6.771686823976779
                        ],
                        [
                          20.81163801002011,
                          -6.689860323298944
                        ],
                        [
                          20.866828209895626,
                          -6.668927962660291
                        ],
                        [
                          20.91352829370864,
                          -6.599174932149708
                        ],
                        [
                          20.991555817670818,
                          -6.5535043271202085
                        ],
                        [
                          21.012490031416792,
                          -6.505930780214385
                        ],
                        [
                          21.041036686524915,
                          -6.484998419576186
                        ],
                        [
                          21.08671133469772,
                          -6.46977488456605
                        ],
                        [
                          21.143804644913985,
                          -6.357501313868852
                        ],
                        [
                          21.33030945828688,
                          -6.153886533112654
                        ],
                        [
                          21.406433871908344,
                          -6.106312986206831
                        ],
                        [
                          21.501589388935283,
                          -6.0492247299198425
                        ],
                        [
                          21.575810692216205,
                          -6.03590413678603
                        ],
                        [
                          21.634807112772872,
                          -6.045418846167195
                        ],
                        [
                          21.75877945338849,
                          -6.108609174881167
                        ],
                        [
                          21.853934970415562,
                          -6.2265915712073365
                        ],
                        [
                          21.901512728929166,
                          -6.338865141904989
                        ],
                        [
                          21.926253163356087,
                          -6.4016622238204945
                        ],
                        [
                          21.926253163356158,
                          -6.430206351963989
                        ],
                        [
                          21.970024701188475,
                          -6.572926992681005
                        ],
                        [
                          21.97002470118835,
                          -6.610985830205209
                        ],
                        [
                          21.990958914934485,
                          -6.669977028368521
                        ],
                        [
                          21.994765135615392,
                          -6.75370647092268
                        ],
                        [
                          22.01950557004232,
                          -6.793668250323208
                        ],
                        [
                          22.015699349361412,
                          -6.85265944848652
                        ],
                        [
                          22.049955335491035,
                          -6.907844762897184
                        ],
                        [
                          22.052378993373242,
                          -7.199232943316929
                        ],
                        [
                          22.0561852140544,
                          -7.301991804633417
                        ],
                        [
                          22.01051056588155,
                          -7.478965399122444
                        ],
                        [
                          21.95722347634635,
                          -7.56840366730512
                        ],
                        [
                          21.953417255665244,
                          -7.612171330458295
                        ],
                        [
                          21.913451938513965,
                          -7.657841935487795
                        ],
                        [
                          21.913451938513834,
                          -7.695900773012454
                        ],
                        [
                          21.941998593622095,
                          -7.779630215566613
                        ],
                        [
                          22.08916538548276,
                          -7.875917033673886
                        ],
                        [
                          22.21857688863949,
                          -7.910169987445897
                        ],
                        [
                          22.30992618498534,
                          -7.921587638703386
                        ],
                        [
                          22.330860398731176,
                          -7.934908231836744
                        ],
                        [
                          22.311829295326046,
                          -7.946325883094687
                        ],
                        [
                          22.03207207526657,
                          -7.946325883094232
                        ],
                        [
                          21.807505055083173,
                          -7.917781754950738
                        ],
                        [
                          21.695221544991313,
                          -7.879722917426079
                        ],
                        [
                          21.695221544991313,
                          -7.879722917426079
                        ],
                        [
                          21.65335311749962,
                          -7.85117878928304
                        ],
                        [
                          21.54487582808872,
                          -7.900655278064733
                        ],
                        [
                          21.284149711435017,
                          -7.9368111737130675
                        ],
                        [
                          21.188994194407947,
                          -7.9368111737130675
                        ],
                        [
                          21.181536511967735,
                          -7.992226802809
                        ],
                        [
                          21.111121429367742,
                          -8.043606233467017
                        ],
                        [
                          20.871329526459807,
                          -8.087373896620193
                        ],
                        [
                          20.59918474776279,
                          -8.159685687916863
                        ],
                        [
                          20.467870134265702,
                          -8.173006281050675
                        ],
                        [
                          20.56302565129252,
                          -7.988420919056352
                        ],
                        [
                          20.580153644357537,
                          -7.948459139655824
                        ],
                        [
                          20.673406051043905,
                          -7.8761473483587
                        ],
                        [
                          20.753336685346287,
                          -7.841894394586689
                        ],
                        [
                          20.833267319648908,
                          -7.683950218859536
                        ],
                        [
                          20.892263740205752,
                          -7.634473730077843
                        ],
                        [
                          21.00454725029759,
                          -7.623056078820355
                        ],
                        [
                          21.073059222556896,
                          -7.643988439459008
                        ],
                        [
                          21.128249422432496,
                          -7.6991737538696725
                        ],
                        [
                          21.154892967200226,
                          -7.7714855451663425
                        ],
                        [
                          21.154892967200166,
                          -7.695367870117025
                        ],
                        [
                          21.08447788460006,
                          -7.619250195067707
                        ],
                        [
                          20.97029126416771,
                          -7.5964148925531845
                        ],
                        [
                          20.878941967822144,
                          -7.605929601934349
                        ],
                        [
                          20.810429995562714,
                          -7.670629625726178
                        ],
                        [
                          20.740014912962728,
                          -7.817156150195842
                        ],
                        [
                          20.661987389000718,
                          -7.851409103967853
                        ],
                        [
                          20.551606989249397,
                          -7.944653255903177
                        ],
                        [
                          20.412679934389978,
                          -7.942750314026853
                        ],
                        [
                          20.247109334763216,
                          -7.897079708997353
                        ],
                        [
                          20.163372479779525,
                          -7.79432084768132
                        ],
                        [
                          20.00351121117434,
                          -7.664920800097661
                        ],
                        [
                          19.83032817018504,
                          -7.588803125048344
                        ],
                        [
                          19.693773664901673,
                          -7.5621696974531005
                        ],
                        [
                          19.941178009171782,
                          -7.664928558769589
                        ],
                        [
                          20.129585932885167,
                          -7.801940373858088
                        ],
                        [
                          20.22093522923114,
                          -7.9180198283079335
                        ],
                        [
                          20.205710346506635,
                          -7.944661014575104
                        ],
                        [
                          20.148617036290453,
                          -7.944661014575104
                        ],
                        [
                          20.091523726074385,
                          -7.904699235174121
                        ],
                        [
                          20.08962061573404,
                          -7.9541757239562685
                        ],
                        [
                          20.013496202112293,
                          -7.933243363317615
                        ],
                        [
                          19.96972466428006,
                          -7.91611688643161
                        ],
                        [
                          19.9697246642799,
                          -7.975108084594922
                        ],
                        [
                          19.92785623678795,
                          -7.975108084594467
                        ],
                        [
                          20.02872108483649,
                          -8.026487515252938
                        ],
                        [
                          19.971627774620433,
                          -8.058837527148626
                        ],
                        [
                          19.86695670589077,
                          -8.051225759643785
                        ],
                        [
                          19.86695670589077,
                          -8.051225759643785
                        ],
                        [
                          19.62145547196143,
                          -7.929437479565422
                        ],
                        [
                          19.431144437907413,
                          -7.7733962457145935
                        ],
                        [
                          19.364535575988608,
                          -7.596422651225112
                        ]
                      ]
                    ]
                  }
                },
                {
                  "typeId": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "area": {
                    "type": "Polygon",
                    "coordinates": [
                      [
                        [
                          21.633555808560633,
                          -6.312280761823786
                        ],
                        [
                          21.649581628557808,
                          -6.316051209208581
                        ],
                        [
                          21.649581628557783,
                          -6.3330182224376586
                        ],
                        [
                          21.61941537915151,
                          -6.361296577819758
                        ],
                        [
                          21.596790692097137,
                          -6.357526130435417
                        ],
                        [
                          21.59396260621503,
                          -6.336788669821544
                        ],
                        [
                          21.610931121506134,
                          -6.318879044746609
                        ]
                      ]
                    ]
                  }
                }
              ],
              "attenuatingZoneTypes": [
                {
                  "id": "e95bb6cb-ca84-48a9-b77d-6017a6cf169c",
                  "name": "Walrus Features",
                  "color": "#6AABF0",
                  "shortcutKey": "",
                  "topEdge": 1.6,
                  "bottomEdge": null,
                  "showInList": true,
                  "attenuationDbPerMeter": 10,
                  "ituRModelEnabled": true,
                  "transparencyEnabled": false
                },
                {
                  "id": "3beb0bf5-b5f0-4e36-9481-5090ca3f9b50",
                  "name": "Walrus Blubber",
                  "color": "#2E6CC7",
                  "shortcutKey": "",
                  "topEdge": 1.4,
                  "bottomEdge": null,
                  "showInList": true,
                  "attenuationDbPerMeter": 30,
                  "ituRModelEnabled": true,
                  "transparencyEnabled": false
                }
              ],
              "scopeZones": [],
              "capacityZones": [],
              "holeInFloorZones": [],
              "accessPoints": [],
              "mapNotes": [],
              "tiePoints": [],
              "cableRisers": [],
              "clientDevices": [],
              "networkInfraDevices": [],
              "raisedFloorZones": [],
              "slopedFloors": []
            }`;

            function setup() {
                const canvas = createCanvas(windowWidth - 420, windowHeight); // The weed number
                canvas.parent("canvas");

                // Load default JSON and render it
                document.getElementById("inputArea").value = defaultJSON;
                parseInput();
            }

            function draw() {
                background(240);
                translate(width / 2, height / 2);
                rotate(rotation);
                scale(zoomLevel);

                // Draw walls first (behind other objects)
                if (
                    objects &&
                    objects.walls &&
                    objects.wallEndpoints &&
                    objects.wallTypes
                ) {
                    drawWalls();
                }

                // Draw attenuating zones
                if (objects && objects.attenuatingZones) {
                    // First, draw all filled shapes
                    for (let zone of objects.attenuatingZones) {
                        const type = objects.attenuatingZoneTypes.find(
                            (t) => t.id === zone.typeId,
                        );
                        if (type && type.color) {
                            let c = color(type.color);
                            c.setAlpha(128); // 50% transparency (0-255 scale)
                            fill(c);
                        } else {
                            fill(200, 128); // Default gray if no color is specified, with 50% transparency
                        }

                        // Draw the filled shape
                        noStroke();
                        beginShape();
                        for (let coord of zone.area.coordinates[0]) {
                            vertex(coord[0] - centerX, coord[1] - centerY);
                        }
                        endShape(CLOSE);
                    }

                    // Then, draw all outlines
                    for (let zone of objects.attenuatingZones) {
                        const type = objects.attenuatingZoneTypes.find(
                            (t) => t.id === zone.typeId,
                        );
                        if (type && type.color) {
                            drawDashedOutline(
                                zone.area.coordinates[0],
                                type.color,
                            );
                        } else {
                            drawDashedOutline(
                                zone.area.coordinates[0],
                                color(0),
                            ); // Default to black if no color specified
                        }
                    }
                }
            }

            function drawWalls() {
                for (let wall of objects.walls) {
                    const wallType = objects.wallTypes.find(
                        (t) => t.id === wall.materialId,
                    );
                    const startEndpoint = objects.wallEndpoints.find(
                        (e) => e.id === wall.startId,
                    );
                    const endEndpoint = objects.wallEndpoints.find(
                        (e) => e.id === wall.endId,
                    );

                    if (wallType && startEndpoint && endEndpoint) {
                        // Wall line color
                        if (wallType.color) {
                            stroke(wallType.color);
                        } else {
                            stroke(0); // Default to black
                        }

                        // Wall line width
                        strokeWeight(2 / zoomLevel);

                        // Draw wall lines
                        line(
                            startEndpoint.x - centerX,
                            startEndpoint.y - centerY,
                            endEndpoint.x - centerX,
                            endEndpoint.y - centerY,
                        );
                    }
                }
            }

            function drawDashedOutline(coordinates, color) {
                stroke(color); // Black color for the outline
                strokeWeight(2 / zoomLevel); // Adjust stroke weight based on zoom level
                noFill();

                for (let i = 0; i < coordinates.length; i++) {
                    let start = coordinates[i];
                    let end = coordinates[(i + 1) % coordinates.length];
                    drawDashedLine(
                        start[0] - centerX,
                        start[1] - centerY,
                        end[0] - centerX,
                        end[1] - centerY,
                    );
                }
            }

            function drawDashedLine(x1, y1, x2, y2) {
                let dashLength = 4 / zoomLevel;
                let gapLength = 4 / zoomLevel;

                let xd = x2 - x1;
                let yd = y2 - y1;
                let dist = sqrt(xd * xd + yd * yd);
                let dashCount = Math.floor(dist / (dashLength + gapLength));
                let dashRemaining = dist - dashCount * (dashLength + gapLength);

                for (let i = 0; i < dashCount; i++) {
                    let startT = (i * (dashLength + gapLength)) / dist;
                    let endT = startT + dashLength / dist;

                    let sx = lerp(x1, x2, startT);
                    let sy = lerp(y1, y2, startT);
                    let ex = lerp(x1, x2, endT);
                    let ey = lerp(y1, y2, endT);

                    line(sx, sy, ex, ey);
                }

                if (dashRemaining > 0) {
                    let startT = 1 - dashRemaining / dist;
                    line(lerp(x1, x2, startT), lerp(y1, y2, startT), x2, y2);
                }
            }

            function windowResized() {
                resizeCanvas(windowWidth - 420, windowHeight);
            }

            function rotateObjects(angle) {
                rotation += angle;
            }

            function parseInput() {
                try {
                    const input = document.getElementById("inputArea").value;
                    objects = JSON.parse(input);

                    // Flip Y-coordinates for Hamina import
                    const canvasElem = document.getElementById("canvas");
                    const canvasHeight =
                        canvasElem && canvasElem.height
                            ? canvasElem.height
                            : canvas.height;
                    if (objects.attenuatingZones) {
                        for (let zone of objects.attenuatingZones) {
                            for (let coord of zone.area.coordinates[0]) {
                                coord[1] = canvasHeight - coord[1];
                            }
                        }
                    }
                    if (objects.wallEndpoints) {
                        for (let endpoint of objects.wallEndpoints) {
                            endpoint.y = canvasHeight - endpoint.y;
                        }
                    }

                    calculateCenter();
                    rotation = 0;
                } catch (error) {
                    console.error("Error parsing input:", error);
                    alert("There's something wrong with the input JSON. 😭");
                }
            }

            function calculateCenter() {
                let minX = Infinity,
                    minY = Infinity,
                    maxX = -Infinity,
                    maxY = -Infinity;

                // Calculate bounds from attenuating zones
                if (objects.attenuatingZones) {
                    for (let zone of objects.attenuatingZones) {
                        for (let coord of zone.area.coordinates[0]) {
                            minX = Math.min(minX, coord[0]);
                            minY = Math.min(minY, coord[1]);
                            maxX = Math.max(maxX, coord[0]);
                            maxY = Math.max(maxY, coord[1]);
                        }
                    }
                }

                // Calculate bounds from wall endpoints
                if (objects.wallEndpoints) {
                    for (let endpoint of objects.wallEndpoints) {
                        minX = Math.min(minX, endpoint.x);
                        minY = Math.min(minY, endpoint.y);
                        maxX = Math.max(maxX, endpoint.x);
                        maxY = Math.max(maxY, endpoint.y);
                    }
                }

                // If no objects found, use defaults
                if (minX === Infinity) {
                    minX = maxX = centerX = 0;
                    minY = maxY = centerY = 0;
                    zoomLevel = 1;
                    return;
                }

                centerX = (minX + maxX) / 2;
                centerY = (minY + maxY) / 2;
                const objectWidth = maxX - minX;
                const objectHeight = maxY - minY;
                zoomLevel =
                    Math.min(width / objectWidth, height / objectHeight) * 0.5;
            }

            function copyOutput() {
                const rotatedObjects = getRotatedObjects();
                if (rotatedObjects) {
                    const output = JSON.stringify(rotatedObjects, null, 2);
                    navigator.clipboard.writeText(output).then(() => {
                        const copyButton =
                            document.getElementById("copyButton");
                        copyButton.style.backgroundColor = "#4CAF50";
                        copyButton.textContent = "Copied!";
                        setTimeout(() => {
                            copyButton.style.backgroundColor = "#4285f4";
                            copyButton.textContent = "Copy to clipboard";
                        }, 1500);
                    });
                } else {
                    alert("No objects to copy. Render the objects first.");
                }
            }

            function getRotatedObjects() {
                if (!objects) return null;

                const rotatedObjects = JSON.parse(JSON.stringify(objects));
                const canvasElem = document.getElementById("canvas");
                const canvasHeight =
                    canvasElem && canvasElem.height
                        ? canvasElem.height
                        : canvas.height;

                // Rotate attenuating zones
                if (rotatedObjects.attenuatingZones) {
                    for (let zone of rotatedObjects.attenuatingZones) {
                        for (let coord of zone.area.coordinates[0]) {
                            const x = coord[0] - centerX;
                            const y = coord[1] - centerY;
                            const rotatedX =
                                x * cos(rotation) - y * sin(rotation);
                            const rotatedY =
                                x * sin(rotation) + y * cos(rotation);
                            coord[0] = rotatedX + centerX;
                            coord[1] = rotatedY + centerY;

                            // Flip Y for Hamina export
                            coord[1] = canvasHeight - coord[1];
                        }
                    }
                }

                // Rotate wall endpoints
                if (rotatedObjects.wallEndpoints) {
                    for (let endpoint of rotatedObjects.wallEndpoints) {
                        const x = endpoint.x - centerX;
                        const y = endpoint.y - centerY;
                        const rotatedX = x * cos(rotation) - y * sin(rotation);
                        const rotatedY = x * sin(rotation) + y * cos(rotation);
                        endpoint.x = rotatedX + centerX;
                        endpoint.y = rotatedY + centerY;

                        // Flip Y for Hamina export
                        endpoint.y = canvasHeight - endpoint.y;
                    }
                }

                return rotatedObjects;
            }

            function clearObjects() {
                objects = null;
                document.getElementById("inputArea").value = "";
                rotation = 0;
                zoomLevel = 1;
                centerX = 0;
                centerY = 0;
                // Redraw the canvas
                draw();
            }
        </script>
    </body>
</html>
